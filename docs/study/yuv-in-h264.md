下面是一份**可直接作为技术文档的 Markdown**，系统、工程化地解释 **H.264 中 YUV 的使用方式**，重点覆盖 **输入格式、编码流程、宏块/分块结构、色度处理、码流层级以及工程实践注意事项**。

---

# H.264 中 YUV 的使用方式详解

## 1. H.264 与 YUV 的关系

H.264（AVC）**不是 RGB 编码标准**，而是**基于 YUV（YCbCr）颜色空间**进行压缩。

* ✅ 输入：**YUV 视频帧**
* ✅ 编码核心：基于 **亮度优先、色度降采样**
* ✅ 输出：H.264 **压缩码流（NAL Units）**

> **所有 H.264 编码运算都发生在 Y、U、V 分量上**，RGB 仅用于输入/输出。

---

## 2. H.264 支持的 YUV 格式

### 2.1 默认与主流格式

| 项目   | 说明                     |
| ---- | ---------------------- |
| 色彩空间 | YCbCr                  |
| 默认采样 | **YUV420**             |
| 位深   | 8-bit（主流）              |
| 布局   | Planar（I420 / YUV420p） |

📌 **99% 的 H.264 视频是 YUV420 8-bit**

---

### 2.2 Profile 与 YUV 支持能力

| Profile    | YUV 采样 | 位深       |
| ---------- | ------ | -------- |
| Baseline   | 4:2:0  | 8-bit    |
| Main       | 4:2:0  | 8-bit    |
| High       | 4:2:0  | 8–10 bit |
| High 4:2:2 | 4:2:2  | 10 bit   |
| High 4:4:4 | 4:4:4  | 8–14 bit |

✅ **AVC High Profile = 4:2:0 是工业标准**

---

## 3. H.264 编码前的 YUV 输入

### 3.1 编码器期望的数据格式

```text
Y plane   -> width × height
U plane   -> (width/2) × (height/2)
V plane   -> (width/2) × (height/2)
```

* Plane 顺序：**Y → U → V**
* 色度采样：**4:2:0**
* 存储类型：**Planar**

✅ FFmpeg / x264 默认：`yuv420p (I420)`

---

### 3.2 RGB → YUV 转换

所有编码器都会先做：

```text
RGB Frame
   ↓
YCbCr (YUV420)
   ↓
H.264 Encoder
```

📌 转换通常在：

* CPU（libswscale）
* GPU（硬件视频管线）
* ISP（摄像头）

---

## 4. 宏块（Macroblock）中的 YUV

### 4.1 宏块尺寸

H.264 基本编码单元：**16×16 Macroblock**

在 **YUV420** 中：

| 分量 | 尺寸      |
| -- | ------- |
| Y  | 16 × 16 |
| U  | 8 × 8   |
| V  | 8 × 8   |

```text
Y Y Y Y Y Y Y Y    U U U U
Y Y Y Y Y Y Y Y    U U U U
...
V V V V
V V V V
```

---

### 4.2 块划分

* Y 分量进一步划分为：

  * 16×16
  * 16×8 / 8×16
  * 8×8 / 4×4
* U/V 对应缩小 1/2

📌 **亮度参与更多预测和变换 → 视觉质量核心**

---

## 5. Y / U / V 的编码差异

### 5.1 预测（Prediction）

| 分量  | 特点         |
| --- | ---------- |
| Y   | 预测模式更多、更精细 |
| U/V | 模式较少、计算简化  |

---

### 5.2 变换（Transform）

* Y：

  * 4×4 / 8×8 整数 DCT
* U/V：

  * 同样 DCT，但块更小、权重更低

---

### 5.3 量化（Quantization）

```text
QP(Y) < QP(U/V)
```

✅ 色度分量 **量化更重**
✅ 人眼不敏感 → 可丢失更多细节

---

## 6. 帧类型中的 YUV

### 6.1 I / P / B 帧

| 帧类型 | YUV 处理        |
| --- | ------------- |
| I 帧 | Y/U/V 独立帧内预测  |
| P 帧 | Y 为主，色度跟随运动矢量 |
| B 帧 | 双向预测，同样 Y 优先  |

📌 **运动估计基于亮度（Y）完成**

---

### 6.2 运动补偿

* 运动矢量在 **Y 平面计算**
* 应用到：

  * Y
  * 同比例应用到 U / V

---

## 7. H.264 解码中的 YUV

```text
H.264 Bitstream
  ↓
Entropy Decode
  ↓
Inverse Quant
  ↓
Inverse Transform
  ↓
YUV Frame (420p)
  ↓
Color Convert
  ↓
RGB for Display
```

📌 解码后几乎总是 **YUV420**

---

## 8. H.264 码流中的 YUV 位置信息

### 8.1 是否直接存储 YUV？

❌ **不直接存储原始 YUV 数据**

✅ 存储的是：

* 残差（Residual）
* 预测模式
* 运动矢量
* 量化参数

---

### 8.2 解码后才能得到 YUV

```text
Annex B / AVCC
   ↓
Decoder
   ↓
Reconstructed YUV Frame
```

---

## 9. 工程实践注意事项（非常重要）

### 9.1 输入格式错误

| 问题   | 原因          |
| ---- | ----------- |
| 颜色发绿 | U/V 顺序错     |
| 偏紫   | NV12 当 I420 |
| 缩放异常 | stride 错    |

---

### 9.2 对齐与 Stride

* Y 行对齐 ≠ width
* U/V 行对齐 ≠ width / 2

✅ 使用编码器要求的 stride

---

### 9.3 硬件编码器差异

| 平台           | 输入          |
| ------------ | ----------- |
| x264         | I420        |
| MediaCodec   | NV12 / NV21 |
| VideoToolbox | NV12        |
| NVENC        | NV12 / P010 |

---

## 10. 总结

✅ H.264 是 **以 YUV420 为核心设计的编码标准**
✅ 编码、预测、运动估计 **全部基于亮度优先原则**
✅ 色度分量：

* 分辨率低
* 量化重
* 数据少

👉 **真正理解 H.264，一定要站在 YUV 角度看编码流程**

---

## 11. 进阶阅读（可继续扩展）

如果你愿意，我可以继续：

* ✅ **H.264 宏块级 YUV 内存布局详解**
* ✅ **x264 / FFmpeg 中 YUV420 输入示例代码**
* ✅ **H.264 与 HEVC 在 YUV 处理上的差异**
* ✅ **硬编码器 NV12 → I420 转换实战**

直接告诉我你想继续哪一部分 👌
